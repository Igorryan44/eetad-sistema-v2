<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Corre√ß√£o Final do Login - EETAD</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .status {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        
        button {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,123,255,0.4);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            white-space: pre-wrap;
        }
        
        .credentials {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .credentials h3 {
            color: #1976d2;
            margin-top: 0;
        }
        
        .step {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        
        .progress {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Corre√ß√£o Final do Sistema de Login</h1>
        
        <div class="status warning">
            <h3>‚ö†Ô∏è Problema Identificado</h3>
            <p>O erro "Usu√°rio ou senha incorretos" pode ter v√°rias causas:</p>
            <ul>
                <li>localStorage corrompido ou vazio</li>
                <li>Hash de senha inconsistente</li>
                <li>Usu√°rio Admin n√£o criado corretamente</li>
                <li>Problemas na comunica√ß√£o com Supabase</li>
                <li>Configura√ß√£o incorreta da planilha Google Sheets</li>
            </ul>
        </div>
        
        <div class="credentials">
            <h3>üîë Credenciais Padr√£o</h3>
            <p><strong>Usu√°rio:</strong> Admin</p>
            <p><strong>Senha:</strong> admin1</p>
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
            <button onclick="runCompletefix()" id="fixBtn">
                üöÄ Executar Corre√ß√£o Completa
            </button>
            <button onclick="testLogin()" id="testBtn" disabled>
                üß™ Testar Login
            </button>
            <button onclick="clearLogs()" id="clearBtn">
                üßπ Limpar Logs
            </button>
        </div>
        
        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div class="log" id="logOutput">Clique em "Executar Corre√ß√£o Completa" para come√ßar...</div>
        
        <div class="step">
            <h4>üìã Passos da Corre√ß√£o:</h4>
            <ol>
                <li>Limpar completamente o localStorage</li>
                <li>Criar usu√°rio Admin com hash correto</li>
                <li>Testar login local</li>
                <li>Configurar planilha Google Sheets</li>
                <li>Testar login via Supabase</li>
                <li>Verificar funcionamento completo</li>
            </ol>
        </div>
    </div>

    <script>
        let logElement = document.getElementById('logOutput');
        let progressBar = document.getElementById('progressBar');
        let currentProgress = 0;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateProgress(percent) {
            currentProgress = percent;
            progressBar.style.width = percent + '%';
        }
        
        function clearLogs() {
            logElement.textContent = '';
            updateProgress(0);
        }
        
        // FUN√á√ÉO DE HASH (EXATA DO SISTEMA)
        function hashPassword(password) {
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }
        
        // LIMPAR SISTEMA
        function clearAuthSystem() {
            log('üßπ Limpando sistema de autentica√ß√£o...');
            localStorage.removeItem('secretary-users');
            localStorage.removeItem('eetad_secretary_session');
            log('‚úÖ Sistema limpo', 'success');
            updateProgress(20);
        }
        
        // CRIAR USU√ÅRIO ADMIN
        function createAdminUser() {
            log('üë§ Criando usu√°rio Admin...');
            
            const adminPassword = 'admin1';
            const adminHash = hashPassword(adminPassword);
            
            const adminUser = {
                id: '1',
                username: 'Admin',
                email: 'admin@eetad.com',
                fullName: 'Administrador',
                passwordHash: adminHash,
                createdAt: new Date().toISOString(),
                status: 'ATIVO'
            };
            
            localStorage.setItem('secretary-users', JSON.stringify([adminUser]));
            
            log(`‚úÖ Usu√°rio Admin criado:`, 'success');
            log(`   Username: ${adminUser.username}`);
            log(`   Password: ${adminPassword}`);
            log(`   Hash: ${adminHash}`);
            updateProgress(40);
            
            return adminUser;
        }
        
        // TESTAR LOGIN LOCAL
        function testLocalLogin(username, password) {
            log(`üîê Testando login local: ${username} / ${password}`);
            
            const users = JSON.parse(localStorage.getItem('secretary-users') || '[]');
            const user = users.find(u => u.username === username);
            
            if (!user) {
                log('‚ùå Usu√°rio n√£o encontrado', 'error');
                return false;
            }
            
            const inputHash = hashPassword(password);
            log(`   Hash digitado: ${inputHash}`);
            log(`   Hash armazenado: ${user.passwordHash}`);
            
            if (user.passwordHash === inputHash) {
                log('‚úÖ Login local bem-sucedido!', 'success');
                updateProgress(60);
                return true;
            } else {
                log('‚ùå Senha incorreta', 'error');
                return false;
            }
        }
        
        // TESTAR LOGIN VIA SUPABASE
        async function testSupabaseLogin(username, password) {
            log(`üì° Testando login via Supabase: ${username} / ${password}`);
            
            try {
                const response = await fetch('https://umkizxftwrwqiiahjbrr.supabase.co/functions/v1/manage-secretary-users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVta2l6eGZ0d3J3cWlpYWhqYnJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNzEyNzIsImV4cCI6MjA2NDY0NzI3Mn0.6rGPdMiRcQ_plkkkHiwy73rOrSoGcLwAqZogNyQplTs'
                    },
                    body: JSON.stringify({
                        action: 'login',
                        username: username,
                        password: password
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`üì° Resposta do Supabase: ${JSON.stringify(result)}`);
                    
                    if (result.success) {
                        log('‚úÖ Login via Supabase funcionou!', 'success');
                        updateProgress(80);
                        return true;
                    } else {
                        log(`‚ùå Login via Supabase falhou: ${result.error}`, 'error');
                        return false;
                    }
                } else {
                    log(`‚ùå Erro HTTP: ${response.status} ${response.statusText}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Erro de conex√£o: ${error.message}`, 'error');
                return false;
            }
        }
        
        // CONFIGURAR GOOGLE SHEETS
        async function setupGoogleSheetsUser() {
            log('üìä Configurando usu√°rio na planilha Google Sheets...');
            
            try {
                const setupResponse = await fetch('https://umkizxftwrwqiiahjbrr.supabase.co/functions/v1/manage-secretary-users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVta2l6eGZ0d3J3cWlpYWhqYnJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNzEyNzIsImV4cCI6MjA2NDY0NzI3Mn0.6rGPdMiRcQ_plkkkHiwy73rOrSoGcLwAqZogNyQplTs'
                    },
                    body: JSON.stringify({
                        action: 'setup-headers'
                    })
                });
                
                if (setupResponse.ok) {
                    const result = await setupResponse.json();
                    log(`‚úÖ Planilha configurada: ${JSON.stringify(result)}`, 'success');
                    return true;
                } else {
                    log(`‚ùå Erro ao configurar planilha: ${setupResponse.status}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Erro ao conectar com Google Sheets: ${error.message}`, 'error');
                return false;
            }
        }
        
        // EXECUTAR CORRE√á√ÉO COMPLETA
        async function runCompletefix() {
            const fixBtn = document.getElementById('fixBtn');
            const testBtn = document.getElementById('testBtn');
            
            fixBtn.disabled = true;
            fixBtn.textContent = 'üîÑ Executando...';
            
            clearLogs();
            log('üöÄ INICIANDO CORRE√á√ÉO COMPLETA DO LOGIN...');
            log('='.repeat(50));
            
            try {
                // Passo 1: Limpar sistema
                clearAuthSystem();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Passo 2: Criar usu√°rio Admin
                const adminUser = createAdminUser();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Passo 3: Testar login local
                const localLoginWorks = testLocalLogin('Admin', 'admin1');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Passo 4: Configurar Google Sheets
                const sheetsConfigured = await setupGoogleSheetsUser();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Passo 5: Testar login via Supabase
                const supabaseLoginWorks = await testSupabaseLogin('Admin', 'admin1');
                
                // Relat√≥rio final
                updateProgress(100);
                log('');
                log('üìã RELAT√ìRIO FINAL:');
                log('='.repeat(50));
                log(`‚úÖ Sistema limpo: SIM`);
                log(`‚úÖ Usu√°rio Admin criado: SIM`);
                log(`‚úÖ Login local funciona: ${localLoginWorks ? 'SIM' : 'N√ÉO'}`);
                log(`‚úÖ Google Sheets configurado: ${sheetsConfigured ? 'SIM' : 'N√ÉO'}`);
                log(`‚úÖ Login via Supabase funciona: ${supabaseLoginWorks ? 'SIM' : 'N√ÉO'}`);
                log('='.repeat(50));
                
                if (localLoginWorks) {
                    log('');
                    log('üéâ CORRE√á√ÉO CONCLU√çDA COM SUCESSO!', 'success');
                    log('üîë Credenciais para login:');
                    log('   Username: Admin');
                    log('   Password: admin1');
                    log('');
                    log('üìç Acesse: http://localhost:3003');
                    log('üí° O sistema agora deve funcionar corretamente!');
                    
                    testBtn.disabled = false;
                } else {
                    log('');
                    log('‚ùå AINDA H√Å PROBLEMAS', 'error');
                    log('üîß Verifique os logs acima para mais detalhes');
                }
                
            } catch (error) {
                log(`‚ùå Erro durante a corre√ß√£o: ${error.message}`, 'error');
            } finally {
                fixBtn.disabled = false;
                fixBtn.textContent = 'üöÄ Executar Corre√ß√£o Completa';
            }
        }
        
        // TESTAR LOGIN
        function testLogin() {
            log('');
            log('üß™ TESTANDO LOGIN FINAL...');
            
            const localResult = testLocalLogin('Admin', 'admin1');
            
            if (localResult) {
                log('');
                log('üéâ TESTE CONCLU√çDO - LOGIN FUNCIONANDO!', 'success');
                log('üåê Agora voc√™ pode acessar: http://localhost:3003');
                log('üîë Use as credenciais: Admin / admin1');
            } else {
                log('');
                log('‚ùå TESTE FALHOU - LOGIN N√ÉO FUNCIONA', 'error');
                log('üîÑ Execute a corre√ß√£o completa novamente');
            }
        }
    </script>
</body>
</html>