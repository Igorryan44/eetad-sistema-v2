<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Correla√ß√£o - Login vs Matr√≠culas</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .status-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid #007bff;
        }
        
        .status-card.success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .status-card.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .status-card.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        
        .btn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,123,255,0.4);
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 500px;
            overflow-y: auto;
            margin: 20px 0;
            white-space: pre-wrap;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .summary {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #2196f3;
        }
        
        .emoji {
            font-size: 1.2em;
            margin-right: 8px;
        }
        
        .test-result {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            background: #f8f9fa;
        }
        
        .test-result.success {
            background: #d4edda;
            color: #155724;
        }
        
        .test-result.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de Correla√ß√£o</h1>
        <p style="text-align: center; color: #666; font-size: 1.1em;">
            Investigando a rela√ß√£o entre problemas de Login e Matr√≠culas Pendentes
        </p>
        
        <div style="text-align: center; margin: 30px 0;">
            <button class="btn" onclick="iniciarDiagnostico()" id="btnDiagnostico">
                üöÄ Iniciar Diagn√≥stico Completo
            </button>
            <button class="btn" onclick="limparLogs()">
                üßπ Limpar Logs
            </button>
        </div>
        
        <div class="progress-bar" id="progressBar" style="display: none;">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div class="status-grid" id="statusGrid" style="display: none;">
            <div class="status-card" id="loginStatus">
                <h3><span class="emoji">üîê</span>Sistema de Login</h3>
                <div id="loginResult">Aguardando teste...</div>
            </div>
            <div class="status-card" id="matriculasStatus">
                <h3><span class="emoji">üìã</span>Matr√≠culas Pendentes</h3>
                <div id="matriculasResult">Aguardando teste...</div>
            </div>
            <div class="status-card" id="debugStatus">
                <h3><span class="emoji">üêõ</span>Debug Matr√≠culas</h3>
                <div id="debugResult">Aguardando teste...</div>
            </div>
        </div>
        
        <div class="summary" id="correlationSummary" style="display: none;">
            <h3><span class="emoji">üß†</span>An√°lise de Correla√ß√£o</h3>
            <div id="correlationResult"></div>
        </div>
        
        <div class="log-container" id="logContainer">
            Clique em "Iniciar Diagn√≥stico" para come√ßar a an√°lise...
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://umkizxftwrwqiiahjbrr.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVta2l6eGZ0d3J3cWlpYWhqYnJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNzEyNzIsImV4cCI6MjA2NDY0NzI3Mn0.6rGPdMiRcQ_plkkkHiwy73rOrSoGcLwAqZogNyQplTs";
        
        let logContainer;
        let progressBar;
        let progressFill;
        
        function log(message, type = 'info') {
            if (!logContainer) logContainer = document.getElementById('logContainer');
            
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            logContainer.textContent += `[${timestamp}] ${emoji} ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function updateProgress(percentage) {
            if (!progressFill) progressFill = document.getElementById('progressFill');
            progressFill.style.width = percentage + '%';
        }
        
        function updateTestResult(testId, success, details) {
            const element = document.getElementById(testId);
            const card = element.closest('.status-card');
            
            if (success) {
                card.className = 'status-card success';
                element.innerHTML = `<div class="test-result success">‚úÖ FUNCIONANDO</div><small>${details}</small>`;
            } else {
                card.className = 'status-card error';
                element.innerHTML = `<div class="test-result error">‚ùå FALHANDO</div><small>${details}</small>`;
            }
        }
        
        async function testSupabaseFunction(functionName, payload = {}) {
            try {
                log(`üß™ Testando fun√ß√£o: ${functionName}`);
                log(`üì° Payload: ${JSON.stringify(payload)}`);
                
                const response = await fetch(`${SUPABASE_URL}/functions/v1/${functionName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify(payload)
                });

                const status = response.status;
                const statusText = response.statusText;
                
                log(`üìä Status: ${status} ${statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    const preview = JSON.stringify(data, null, 2).substring(0, 200) + '...';
                    log(`‚úÖ Sucesso! Dados: ${preview}`, 'success');
                    return { success: true, data, status };
                } else {
                    const errorText = await response.text();
                    const preview = errorText.substring(0, 200) + '...';
                    log(`‚ùå Erro! Resposta: ${preview}`, 'error');
                    return { success: false, error: errorText, status };
                }
            } catch (error) {
                log(`üí• Exce√ß√£o: ${error.message}`, 'error');
                return { success: false, error: error.message, status: 'EXCEPTION' };
            }
        }
        
        function checkLocalStorage() {
            log('üóÑÔ∏è Verificando localStorage...');
            
            // Verificar sess√£o
            const session = localStorage.getItem('eetad_secretary_session');
            log(`üîê Sess√£o ativa: ${session ? 'SIM' : 'N√ÉO'}`);
            
            if (session) {
                try {
                    const sessionData = JSON.parse(session);
                    log(`üë§ Usu√°rio: ${sessionData.user?.username || 'Desconhecido'}`);
                    log(`‚è∞ Expira: ${new Date(sessionData.expiresAt).toLocaleString()}`);
                } catch (e) {
                    log(`‚ùå Erro ao parsear sess√£o: ${e.message}`, 'error');
                }
            }
            
            // Verificar usu√°rios
            const users = localStorage.getItem('secretary-users');
            log(`üë• Usu√°rios cadastrados: ${users ? 'SIM' : 'N√ÉO'}`);
            
            if (users) {
                try {
                    const userList = JSON.parse(users);
                    log(`üìä Quantidade: ${userList.length} usu√°rios`);
                } catch (e) {
                    log(`‚ùå Erro ao parsear usu√°rios: ${e.message}`, 'error');
                }
            }
        }
        
        async function iniciarDiagnostico() {
            const btn = document.getElementById('btnDiagnostico');
            btn.disabled = true;
            btn.textContent = 'üîÑ Executando...';
            
            // Mostrar elementos
            document.getElementById('progressBar').style.display = 'block';
            document.getElementById('statusGrid').style.display = 'grid';
            
            log('üöÄ Iniciando diagn√≥stico de correla√ß√£o...', 'info');
            log('=' .repeat(50));
            
            updateProgress(10);
            
            // 1. Verificar localStorage
            checkLocalStorage();
            updateProgress(20);
            
            // 2. Testar login
            log('\nüîê TESTANDO SISTEMA DE LOGIN');
            log('-'.repeat(30));
            
            const loginTest = await testSupabaseFunction('manage-secretary-users', {
                action: 'login',
                username: 'Admin',
                password: 'admin1'
            });
            
            updateTestResult('loginResult', loginTest.success, 
                `Status: ${loginTest.status} | ${loginTest.success ? 'Login funcionando' : 'Falha no login'}`);
            updateProgress(40);
            
            // 3. Testar matr√≠culas
            log('\nüìã TESTANDO MATR√çCULAS PENDENTES');
            log('-'.repeat(30));
            
            const pendingTest = await testSupabaseFunction('get-pending-enrollments', {});
            
            updateTestResult('matriculasResult', pendingTest.success,
                `Status: ${pendingTest.status} | ${pendingTest.success ? 'Matr√≠culas funcionando' : 'Falha nas matr√≠culas'}`);
            updateProgress(60);
            
            // 4. Testar debug
            log('\nüêõ TESTANDO DEBUG MATR√çCULAS');
            log('-'.repeat(30));
            
            const debugTest = await testSupabaseFunction('get-pending-enrollments', { debug: true });
            
            updateTestResult('debugResult', debugTest.success,
                `Status: ${debugTest.status} | ${debugTest.success ? 'Debug funcionando' : 'Falha no debug'}`);
            updateProgress(80);
            
            // 5. An√°lise de correla√ß√£o
            log('\nüîç AN√ÅLISE DE CORRELA√á√ÉO');
            log('='.repeat(40));
            
            let correlationHtml = '<h4>üìä Resultados dos Testes:</h4>';
            correlationHtml += `<div class="test-result ${loginTest.success ? 'success' : 'error'}">üîê Login: ${loginTest.success ? 'FUNCIONANDO' : 'FALHANDO'} (${loginTest.status})</div>`;
            correlationHtml += `<div class="test-result ${pendingTest.success ? 'success' : 'error'}">üìã Matr√≠culas: ${pendingTest.success ? 'FUNCIONANDO' : 'FALHANDO'} (${pendingTest.status})</div>`;
            correlationHtml += `<div class="test-result ${debugTest.success ? 'success' : 'error'}">üêõ Debug: ${debugTest.success ? 'FUNCIONANDO' : 'FALHANDO'} (${debugTest.status})</div>`;
            
            correlationHtml += '<h4>üß† An√°lise da Correla√ß√£o:</h4>';
            
            if (!loginTest.success && !pendingTest.success) {
                correlationHtml += '<div class="test-result error">‚ùå AMBOS FALHANDO - Problema sist√™mico detectado!</div>';
                correlationHtml += '<p><strong>Poss√≠veis causas:</strong></p>';
                correlationHtml += '<ul><li>Conectividade com Supabase</li><li>Credenciais inv√°lidas</li><li>Fun√ß√µes n√£o deployadas</li><li>Problema de CORS</li></ul>';
                log('‚ùå CORRELA√á√ÉO CONFIRMADA: Ambos falhando - problema sist√™mico', 'error');
            } else if (loginTest.success && !pendingTest.success) {
                correlationHtml += '<div class="test-result warning">‚ö†Ô∏è LOGIN OK, MATR√çCULAS FALHANDO</div>';
                correlationHtml += '<p><strong>Poss√≠veis causas:</strong></p>';
                correlationHtml += '<ul><li>Credenciais Google Sheets n√£o configuradas</li><li>Problema espec√≠fico na fun√ß√£o get-pending-enrollments</li><li>Planilha inacess√≠vel</li></ul>';
                log('‚ö†Ô∏è CORRELA√á√ÉO PARCIAL: Login OK, matr√≠culas falhando', 'warning');
            } else if (!loginTest.success && pendingTest.success) {
                correlationHtml += '<div class="test-result warning">‚ö†Ô∏è MATR√çCULAS OK, LOGIN FALHANDO</div>';
                correlationHtml += '<p><strong>Poss√≠veis causas:</strong></p>';
                correlationHtml += '<ul><li>Problema na fun√ß√£o manage-secretary-users</li><li>Aba "usuarios" n√£o configurada</li><li>Conflito de autentica√ß√£o</li></ul>';
                log('‚ö†Ô∏è CORRELA√á√ÉO PARCIAL: Matr√≠culas OK, login falhando', 'warning');
            } else {
                correlationHtml += '<div class="test-result success">‚úÖ AMBOS FUNCIONANDO - Sistema operacional!</div>';
                log('‚úÖ NENHUMA CORRELA√á√ÉO: Ambos funcionando normalmente', 'success');
            }
            
            // Informa√ß√µes de debug se dispon√≠veis
            if (debugTest.success && debugTest.data?.debug) {
                correlationHtml += '<h4>üêõ Informa√ß√µes de Debug:</h4>';
                const debug = debugTest.data.debug;
                correlationHtml += `<p>Credenciais configuradas: ${debug.credentialsConfigured || 'N/A'}</p>`;
                correlationHtml += `<p>Dados pessoais: ${debug.totalDadosPessoaisRows || 'N/A'} linhas</p>`;
                correlationHtml += `<p>Matr√≠culas: ${debug.totalMatriculasRows || 'N/A'} linhas</p>`;
            }
            
            document.getElementById('correlationResult').innerHTML = correlationHtml;
            document.getElementById('correlationSummary').style.display = 'block';
            
            updateProgress(100);
            
            log('\nüèÅ Diagn√≥stico conclu√≠do!', 'success');
            log('Verifique a an√°lise de correla√ß√£o acima para entender a rela√ß√£o entre os problemas.');
            
            btn.disabled = false;
            btn.textContent = 'üîÑ Executar Novamente';
        }
        
        function limparLogs() {
            document.getElementById('logContainer').textContent = 'Logs limpos. Clique em "Iniciar Diagn√≥stico" para come√ßar...';
            document.getElementById('progressBar').style.display = 'none';
            document.getElementById('statusGrid').style.display = 'none';
            document.getElementById('correlationSummary').style.display = 'none';
        }
    </script>
</body>
</html>